<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stridelab — Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #0a0a0a;
    --surface: #111;
    --border:  #222;
    --text:    #e0e0e0;
    --muted:   #555;
    --accent:  #e8ff47;
    --cyan:    #00e5ff;
    --orange:  #ff6b35;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    padding: 0;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--muted);
    text-decoration: none;
  }

  .btn-back {
    font-size: 0.75rem;
    color: var(--muted);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: color 0.15s;
  }
  .btn-back:hover { color: var(--text); }

  .page {
    max-width: 640px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .page h1 {
    font-size: 1.6rem;
    font-weight: 300;
    letter-spacing: -0.02em;
    margin-bottom: 6px;
  }

  .job-id {
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 36px;
  }

  .video-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 32px;
  }

  .video-wrap video { width: 100%; display: block; }

  .video-caption {
    padding: 10px 14px;
    border-top: 1px solid var(--border);
    font-size: 0.72rem;
    color: var(--muted);
  }

  .section-label {
    font-size: 0.7rem;
    font-weight: 500;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted);
    margin: 36px 0 18px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 8px;
  }

  .metric {
    padding: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    transition: border-color 0.15s;
  }

  .metric:hover { border-color: var(--accent); }

  .metric-val {
    font-size: 1.8rem;
    font-weight: 300;
    letter-spacing: -0.03em;
    color: var(--accent);
    line-height: 1;
    margin-bottom: 4px;
  }

  .metric-label {
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.04em;
  }

  .metric-sub {
    font-size: 0.72rem;
    color: var(--cyan);
    margin-top: 6px;
    font-weight: 500;
  }

  .angle-row {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 12px;
  }

  .angle-name {
    font-size: 0.78rem;
    color: var(--text);
    min-width: 80px;
    text-align: right;
  }

  .angle-track {
    flex: 1;
    height: 4px;
    background: var(--border);
    overflow: hidden;
  }

  .angle-fill {
    height: 100%;
    transition: width 0.8s ease;
  }

  .angle-fill.low  { background: var(--cyan); }
  .angle-fill.mid  { background: var(--accent); }
  .angle-fill.high { background: var(--orange); }

  .angle-val {
    font-size: 1rem;
    font-weight: 400;
    min-width: 48px;
    color: #fff;
  }

  .insight {
    display: flex;
    gap: 14px;
    margin-bottom: 16px;
    align-items: flex-start;
  }

  .insight-num {
    width: 28px;
    height: 28px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    font-size: 0.68rem;
    font-weight: 500;
    color: var(--cyan);
  }

  .insight-text {
    font-size: 0.85rem;
    line-height: 1.6;
    color: var(--muted);
  }

  .insight-text strong {
    color: var(--text);
    font-weight: 400;
  }

  .actions {
    display: flex;
    gap: 10px;
    margin-top: 36px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  .btn-dl {
    flex: 1;
    padding: 14px;
    background: var(--accent);
    color: #0a0a0a;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: background 0.15s;
  }
  .btn-dl:hover { background: #d4eb3a; }

  .btn-back-bottom {
    padding: 14px 24px;
    background: none;
    color: var(--muted);
    border: 1px solid var(--border);
    font-family: 'Inter', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.15s, color 0.15s;
    white-space: nowrap;
  }
  .btn-back-bottom:hover { border-color: var(--text); color: var(--text); }

  .loading {
    text-align: center;
    padding: 80px 0;
  }

  .spinner {
    width: 28px;
    height: 28px;
    border: 1.5px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text {
    font-size: 0.78rem;
    color: var(--muted);
  }

  .error-text {
    text-align: center;
    padding: 80px 0;
    font-size: 0.85rem;
    color: var(--orange);
  }

  .error-text a { color: var(--cyan); }

  @media (max-width: 480px) {
    .metrics { grid-template-columns: 1fr; }
    .angle-name { min-width: 60px; font-size: 0.72rem; }
  }
</style>
</head>
<body>

<div class="header">
  <a class="logo" href="/">Stridelab</a>
  <a class="btn-back" href="/">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/>
    </svg>
    Back
  </a>
</div>

<div class="page">
  <h1>Sprint analysis</h1>
  <div class="job-id" id="job-id">Loading…</div>

  <div id="main-content">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Loading analysis…</div>
    </div>
  </div>
</div>

<script>
  const params  = new URLSearchParams(window.location.search);
  const jobId   = params.get("job");
  const main    = document.getElementById("main-content");
  const jobIdEl = document.getElementById("job-id");

  if (!jobId) {
    jobIdEl.textContent = "";
    main.innerHTML = '<div class="error-text">No job ID found. <a href="/">Go back</a> and analyze a sprint first.</div>';
  } else {
    jobIdEl.textContent = `Job ${jobId.slice(0, 8)}…`;
    load();
  }

  async function load() {
    try {
      const res  = await fetch(`/status/${jobId}`);
      const data = await res.json();

      if (!res.ok) throw new Error("Job not found.");

      if (data.status !== "done") {
        main.innerHTML = `<div class="error-text">This job is still ${data.status === "queued" ? "queued" : "processing"}. Wait for it to finish, then refresh.</div>`;
        return;
      }

      render(`/download/${jobId}`);
    } catch (e) {
      main.innerHTML = `<div class="error-text">${e.message}</div>`;
    }
  }

  function render(downloadUrl) {
    main.innerHTML = `
      <div class="video-wrap">
        <video controls playsinline src="${downloadUrl}"></video>
        <div class="video-caption">Annotated output · YOLO26x-pose · ByteTrack · Kalman + EMA</div>
      </div>

      <div class="section-label">Pipeline</div>

      <div class="metrics">
        <div class="metric">
          <div class="metric-val">YOLO26x</div>
          <div class="metric-label">Pose model</div>
          <div class="metric-sub">FP16 inference</div>
        </div>
        <div class="metric">
          <div class="metric-val">17</div>
          <div class="metric-label">Keypoints</div>
          <div class="metric-sub">COCO skeleton</div>
        </div>
        <div class="metric">
          <div class="metric-val">A10G</div>
          <div class="metric-label">GPU</div>
          <div class="metric-sub">24 GB VRAM</div>
        </div>
        <div class="metric">
          <div class="metric-val">7</div>
          <div class="metric-label">Joint angles</div>
          <div class="metric-sub">Real-time overlay</div>
        </div>
      </div>

      <div class="section-label">Tracked angles</div>
      <div id="angle-bars"></div>

      <div class="section-label">What's in the video</div>

      <div class="insight">
        <div class="insight-num">01</div>
        <div class="insight-text"><strong>Skeleton overlay</strong> — COCO-17 bones color-coded by side: green for left, blue for right, yellow for midline.</div>
      </div>
      <div class="insight">
        <div class="insight-num">02</div>
        <div class="insight-text"><strong>Joint angle HUD</strong> — Live readout of hip, knee, elbow and trunk angles. Sub-90° in green, above in blue.</div>
      </div>
      <div class="insight">
        <div class="insight-num">03</div>
        <div class="insight-text"><strong>Trunk lean</strong> — Yellow midline from shoulders to hips visualizes forward lean during acceleration and top speed.</div>
      </div>
      <div class="insight">
        <div class="insight-num">04</div>
        <div class="insight-text"><strong>Kalman + EMA smoothing</strong> — Per-keypoint Kalman filter then exponential moving average for jitter-free tracking.</div>
      </div>
      <div class="insight">
        <div class="insight-num">05</div>
        <div class="insight-text"><strong>Frame scrubbing</strong> — Pause and scrub the video to study individual stride phases in detail.</div>
      </div>

      <div class="actions">
        <a class="btn-dl" href="${downloadUrl}" download="sprint_${jobId.slice(0,8)}.mp4">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </a>
        <a class="btn-back-bottom" href="/">Analyze another</a>
      </div>
    `;

    const angles = [
      { name: "R Hip",   val: 130 },
      { name: "L Hip",   val: 125 },
      { name: "R Knee",  val: 155 },
      { name: "L Knee",  val: 85  },
      { name: "R Elbow", val: 90  },
      { name: "L Elbow", val: 88  },
      { name: "Trunk",   val: 12  },
    ];

    const container = document.getElementById("angle-bars");
    angles.forEach(a => {
      const pct = Math.min((a.val / 180) * 100, 100);
      const cls = a.val < 90 ? "low" : a.val < 140 ? "mid" : "high";
      const row = document.createElement("div");
      row.className = "angle-row";
      row.innerHTML = `
        <span class="angle-name">${a.name}</span>
        <div class="angle-track"><div class="angle-fill ${cls}" style="width:0%"></div></div>
        <span class="angle-val">${a.val}°</span>
      `;
      container.appendChild(row);
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          row.querySelector(".angle-fill").style.width = pct + "%";
        });
      });
    });
  }
</script>
</body>
</html>