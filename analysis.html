<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stridelab — Analysis</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #0a0a0a;
    --surface: #111;
    --border:  #222;
    --text:    #e0e0e0;
    --muted:   #555;
    --accent:  #e8ff47;
    --cyan:    #00e5ff;
    --orange:  #ff6b35;
    --green:   #4caf81;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    min-height: 100vh;
  }

  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    border-bottom: 1px solid var(--border);
  }

  .logo {
    font-size: 0.8rem; font-weight: 500;
    letter-spacing: 0.25em; text-transform: uppercase;
    color: var(--muted); text-decoration: none;
  }

  .btn-back {
    font-size: 0.75rem; color: var(--muted);
    text-decoration: none; display: flex;
    align-items: center; gap: 6px;
    transition: color 0.15s;
  }
  .btn-back:hover { color: var(--text); }

  .page {
    max-width: 720px;
    margin: 0 auto;
    padding: 48px 24px 80px;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .page h1 { font-size: 1.6rem; font-weight: 300; letter-spacing: -0.02em; margin-bottom: 6px; }
  .sub-info { font-size: 0.75rem; color: var(--muted); margin-bottom: 36px; }

  /* Video */
  .video-wrap {
    background: var(--surface); border: 1px solid var(--border);
    overflow: hidden; margin-bottom: 32px;
  }
  .video-wrap video { width: 100%; display: block; }
  .video-caption {
    padding: 10px 14px; border-top: 1px solid var(--border);
    font-size: 0.72rem; color: var(--muted);
  }

  /* Section */
  .section-label {
    font-size: 0.7rem; font-weight: 500; letter-spacing: 0.18em;
    text-transform: uppercase; color: var(--muted);
    margin: 36px 0 18px; display: flex; align-items: center; gap: 12px;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* Stats */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 10px; margin-bottom: 8px;
  }
  .stat-card { padding: 16px; background: var(--surface); border: 1px solid var(--border); }
  .stat-val {
    font-size: 1.5rem; font-weight: 300; letter-spacing: -0.03em;
    color: var(--accent); line-height: 1; margin-bottom: 3px;
  }
  .stat-label { font-size: 0.68rem; color: var(--muted); }

  /* Angle table */
  .angle-table { width: 100%; border-collapse: collapse; }
  .angle-table th {
    text-align: left; font-size: 0.68rem; font-weight: 500;
    letter-spacing: 0.12em; text-transform: uppercase;
    color: var(--muted); padding: 8px 12px;
    border-bottom: 1px solid var(--border);
  }
  .angle-table td {
    font-size: 0.85rem; padding: 10px 12px;
    border-bottom: 1px solid var(--border);
  }
  .angle-table tr:last-child td { border-bottom: none; }
  .angle-table .name { font-weight: 400; }
  .angle-table .val  { color: var(--accent); font-weight: 400; }
  .angle-table .range { color: var(--muted); font-size: 0.78rem; }
  .bar-cell { width: 30%; }
  .mini-bar-track { height: 4px; background: var(--border); overflow: hidden; }
  .mini-bar-fill { height: 100%; transition: width 0.8s ease; }
  .mini-bar-fill.low  { background: var(--cyan); }
  .mini-bar-fill.mid  { background: var(--accent); }
  .mini-bar-fill.high { background: var(--orange); }

  /* Chart */
  .chart-wrap {
    background: var(--surface); border: 1px solid var(--border);
    padding: 20px; overflow-x: auto;
  }
  canvas { display: block; }
  .chart-legend {
    display: flex; flex-wrap: wrap; gap: 14px; margin-top: 14px;
  }
  .legend-item {
    display: flex; align-items: center; gap: 5px;
    font-size: 0.7rem; color: var(--muted); cursor: pointer;
    transition: opacity 0.15s;
  }
  .legend-item.off { opacity: 0.25; }
  .legend-dot { width: 8px; height: 8px; flex-shrink: 0; }

  /* Actions */
  .actions {
    display: flex; gap: 10px; margin-top: 36px;
    padding-top: 24px; border-top: 1px solid var(--border);
  }
  .btn-dl {
    flex: 1; padding: 14px; background: var(--accent); color: #0a0a0a;
    border: none; font-family: 'Inter', sans-serif; font-size: 0.78rem;
    font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase;
    cursor: pointer; text-decoration: none;
    display: flex; align-items: center; justify-content: center; gap: 7px;
    transition: background 0.15s;
  }
  .btn-dl:hover { background: #d4eb3a; }
  .btn-secondary {
    padding: 14px 24px; background: none; color: var(--muted);
    border: 1px solid var(--border); font-family: 'Inter', sans-serif;
    font-size: 0.78rem; cursor: pointer; text-decoration: none;
    display: flex; align-items: center; justify-content: center;
    transition: border-color 0.15s, color 0.15s; white-space: nowrap;
  }
  .btn-secondary:hover { border-color: var(--text); color: var(--text); }

  /* Loading / error */
  .status-msg { text-align: center; padding: 80px 0; }
  .spinner {
    width: 28px; height: 28px;
    border: 1.5px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    margin: 0 auto 16px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .status-msg p { font-size: 0.78rem; color: var(--muted); }
  .status-msg.error p { color: var(--orange); }
  .status-msg a { color: var(--cyan); }

  @media (max-width: 560px) {
    .stats-row { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <a class="logo" href="/">Stridelab</a>
  <a class="btn-back" href="/">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/>
    </svg>
    Back
  </a>
</div>

<div class="page">
  <h1>Sprint analysis</h1>
  <div class="sub-info" id="sub-info">Loading…</div>
  <div id="content">
    <div class="status-msg" id="loader">
      <div class="spinner"></div>
      <p>Fetching analysis data from server…</p>
    </div>
  </div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const jobId  = params.get("job");
const contentEl = document.getElementById("content");
const subInfo   = document.getElementById("sub-info");

if (!jobId) {
  subInfo.textContent = "";
  contentEl.innerHTML = '<div class="status-msg error"><p>No job ID. <a href="/">Go back</a> and analyze a sprint first.</p></div>';
} else {
  subInfo.textContent = `Job ${jobId.slice(0,8)}…`;
  fetchAnalysis();
}

async function fetchAnalysis() {
  try {
    const res = await fetch(`/analysis/${jobId}`);
    if (res.status === 404) {
      // Maybe job isn't done yet — check status
      const sr = await fetch(`/status/${jobId}`);
      const sd = await sr.json();
      if (!sr.ok) throw new Error("Job not found. It may have expired.");
      contentEl.innerHTML = `<div class="status-msg error"><p>Analysis not ready — job is still <strong>${sd.status}</strong>. Wait for it to finish then refresh.</p></div>`;
      return;
    }
    if (!res.ok) throw new Error("Failed to load analysis.");
    const data = await res.json();
    render(data);
  } catch (e) {
    contentEl.innerHTML = `<div class="status-msg error"><p>${e.message}</p></div>`;
  }
}

function render(data) {
  const dlUrl = `/download/${jobId}`;
  subInfo.textContent = `Job ${jobId.slice(0,8)}… · ${data.duration_s}s · ${data.total_frames} frames · ${data.width}×${data.height} · ${data.fps} fps`;

  // Build angle table rows
  const angleNames = ["R Hip", "L Hip", "R Knee", "L Knee", "R Elbow", "L Elbow", "Trunk"];
  let tableRows = "";
  angleNames.forEach(name => {
    const s = data.summary[name];
    if (!s) {
      tableRows += `<tr><td class="name">${name}</td><td class="val">—</td><td class="range">—</td><td class="bar-cell"><div class="mini-bar-track"><div class="mini-bar-fill" style="width:0%"></div></div></td></tr>`;
      return;
    }
    const pct = Math.min((s.mean / 180) * 100, 100);
    const cls = s.mean < 90 ? "low" : s.mean < 140 ? "mid" : "high";
    tableRows += `<tr>
      <td class="name">${name}</td>
      <td class="val">${s.mean}°</td>
      <td class="range">${s.min}° – ${s.max}° &nbsp;(±${s.std}°)</td>
      <td class="bar-cell"><div class="mini-bar-track"><div class="mini-bar-fill ${cls}" data-pct="${pct}" style="width:0%"></div></div></td>
    </tr>`;
  });

  contentEl.innerHTML = `
    <div class="video-wrap">
      <video controls playsinline src="${dlUrl}"></video>
      <div class="video-caption">Annotated output · YOLO26x-pose · ByteTrack · Kalman + EMA</div>
    </div>

    <div class="section-label">Video info</div>
    <div class="stats-row">
      <div class="stat-card"><div class="stat-val">${data.duration_s}s</div><div class="stat-label">Duration</div></div>
      <div class="stat-card"><div class="stat-val">${data.total_frames}</div><div class="stat-label">Frames</div></div>
      <div class="stat-card"><div class="stat-val">${data.fps}</div><div class="stat-label">FPS</div></div>
      <div class="stat-card"><div class="stat-val">${data.width}×${data.height}</div><div class="stat-label">Resolution</div></div>
    </div>

    <div class="section-label">Average joint angles</div>
    <table class="angle-table">
      <thead><tr><th>Joint</th><th>Mean</th><th>Range</th><th>Distribution</th></tr></thead>
      <tbody>${tableRows}</tbody>
    </table>

    <div class="section-label">Angles over time</div>
    <div class="chart-wrap">
      <canvas id="chart" height="260"></canvas>
      <div class="chart-legend" id="chart-legend"></div>
    </div>

    <div class="actions">
      <a class="btn-dl" href="${dlUrl}" download="sprint_${jobId.slice(0,8)}.mp4">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Download video
      </a>
      <a class="btn-secondary" href="/">Analyze another</a>
    </div>
  `;

  // Animate bars
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      document.querySelectorAll(".mini-bar-fill[data-pct]").forEach(el => {
        el.style.width = el.dataset.pct + "%";
      });
    });
  });

  // Draw chart
  drawChart(data);
}

// ── Canvas chart — no external dependencies ──────────────────────────────────
function drawChart(data) {
  const canvas = document.getElementById("chart");
  const ctx    = canvas.getContext("2d");
  const dpr    = window.devicePixelRatio || 1;

  canvas.width  = canvas.clientWidth * dpr;
  canvas.height = 260 * dpr;
  ctx.scale(dpr, dpr);

  const W = canvas.clientWidth;
  const H = 260;
  const PAD = { top: 16, right: 16, bottom: 32, left: 44 };
  const plotW = W - PAD.left - PAD.right;
  const plotH = H - PAD.top  - PAD.bottom;

  const colors = {
    "R Hip":   "#ff6b35",
    "L Hip":   "#ff9f6b",
    "R Knee":  "#00e5ff",
    "L Knee":  "#66f0ff",
    "R Elbow": "#e8ff47",
    "L Elbow": "#c8dd3a",
    "Trunk":   "#4caf81",
  };

  const angleNames = Object.keys(colors);
  const hidden = new Set();

  // Sample frames (draw max 300 points for performance)
  const frames = data.frames;
  const step   = Math.max(1, Math.floor(frames.length / 300));
  const sampled = frames.filter((_, i) => i % step === 0);

  const maxTime = sampled.length > 0 ? sampled[sampled.length - 1].time : 1;

  function draw() {
    ctx.clearRect(0, 0, W, H);

    // Grid
    ctx.strokeStyle = "#1a1a1a";
    ctx.lineWidth   = 1;
    const yTicks = [0, 45, 90, 135, 180];
    yTicks.forEach(v => {
      const y = PAD.top + plotH - (v / 180) * plotH;
      ctx.beginPath();
      ctx.moveTo(PAD.left, y);
      ctx.lineTo(PAD.left + plotW, y);
      ctx.stroke();
      ctx.fillStyle = "#444";
      ctx.font = "10px Inter, sans-serif";
      ctx.textAlign = "right";
      ctx.fillText(v + "°", PAD.left - 6, y + 3);
    });

    // Time axis labels
    ctx.fillStyle = "#444";
    ctx.textAlign = "center";
    const tStep = Math.ceil(maxTime / 5);
    for (let t = 0; t <= maxTime; t += tStep) {
      const x = PAD.left + (t / maxTime) * plotW;
      ctx.fillText(t.toFixed(1) + "s", x, H - 8);
    }

    // Lines
    angleNames.forEach(name => {
      if (hidden.has(name)) return;
      ctx.strokeStyle = colors[name];
      ctx.lineWidth   = 1.5;
      ctx.beginPath();
      let started = false;

      sampled.forEach(f => {
        const v = f.angles[name];
        if (v == null) return;
        const x = PAD.left + (f.time / maxTime) * plotW;
        const y = PAD.top + plotH - (v / 180) * plotH;
        if (!started) { ctx.moveTo(x, y); started = true; }
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    });
  }

  draw();

  // Legend
  const legendEl = document.getElementById("chart-legend");
  angleNames.forEach(name => {
    const item = document.createElement("div");
    item.className = "legend-item";
    item.innerHTML = `<span class="legend-dot" style="background:${colors[name]}"></span>${name}`;
    item.addEventListener("click", () => {
      if (hidden.has(name)) hidden.delete(name); else hidden.add(name);
      item.classList.toggle("off");
      draw();
    });
    legendEl.appendChild(item);
  });
}
</script>
</body>
</html>