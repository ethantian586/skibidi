<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stridelab</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÉ</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@300;400;700;800&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #030308;
    --surface: #0a0a14;
    --border:  #1a1a2e;
    --text:    #e8e8f0;
    --muted:   #3a3a5c;
    --accent:  #e8ff47;
    --cyan:    #00f5ff;
    --purple:  #6366f1;
    --glow:    rgba(232, 255, 71, 0.15);
    --cyan-glow: rgba(0, 245, 255, 0.15);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
    position: relative;
    overflow: hidden;
  }

  /* Animated background canvas */
  #bg-canvas {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
  }

  /* Animated aurora glow */
  .aurora {
    position: fixed;
    top: -30%;
    left: -20%;
    width: 140%;
    height: 70%;
    background:
      radial-gradient(ellipse 50% 60% at 30% 50%, rgba(99,102,241,0.08) 0%, transparent 70%),
      radial-gradient(ellipse 50% 60% at 70% 50%, rgba(0,245,255,0.06) 0%, transparent 70%);
    animation: aurora-drift 12s ease-in-out infinite alternate;
    pointer-events: none;
    z-index: 0;
    filter: blur(40px);
  }
  @keyframes aurora-drift {
    0%   { transform: translateX(-5%) translateY(0%) rotate(-2deg); opacity: 0.6; }
    33%  { transform: translateX(3%) translateY(3%) rotate(1deg); opacity: 1; }
    66%  { transform: translateX(-2%) translateY(-2%) rotate(-1deg); opacity: 0.7; }
    100% { transform: translateX(5%) translateY(1%) rotate(2deg); opacity: 0.9; }
  }

  /* Subtle scan line overlay */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0, 245, 255, 0.008) 2px,
      rgba(0, 245, 255, 0.008) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* Ensure content sits above the animated background */
  .logo, .card { position: relative; z-index: 1; }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    font-weight: 400;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: var(--cyan);
    margin-bottom: 56px;
    text-shadow: 0 0 12px rgba(0, 245, 255, 0.5);
    transition: text-shadow 0.3s;
  }
  .logo:hover { text-shadow: 0 0 20px rgba(0, 245, 255, 0.8); }

  .card {
    width: 100%;
    max-width: 480px;
    animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(24px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ Upload ‚îÄ‚îÄ */
  #upload-section h1 {
    font-family: 'Syne', sans-serif;
    font-size: 1.9rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    margin-bottom: 8px;
    color: var(--cyan);
    text-shadow: 0 0 30px rgba(0, 245, 255, 0.25);
  }

  #upload-section p {
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    color: var(--muted);
    line-height: 1.8;
    margin-bottom: 36px;
    letter-spacing: 0.02em;
  }

  .drop-zone {
    border: 1px solid var(--border);
    padding: 52px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    position: relative;
    transition: border-color 0.3s, background 0.3s, box-shadow 0.3s;
    text-align: center;
    background: var(--surface);
    overflow: hidden;
  }

  /* HUD corner brackets on drop zone */
  .drop-zone::before, .drop-zone::after {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    border-color: var(--cyan);
    border-style: solid;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .drop-zone::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
  .drop-zone::after  { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }

  .drop-zone:hover::before,
  .drop-zone:hover::after,
  .drop-zone.dragover::before,
  .drop-zone.dragover::after { opacity: 0.7; }

  .drop-zone:hover,
  .drop-zone.dragover {
    border-color: rgba(0, 245, 255, 0.3);
    background: rgba(0, 245, 255, 0.03);
    box-shadow: 0 0 40px rgba(0, 245, 255, 0.08), inset 0 0 40px rgba(0, 245, 255, 0.02);
  }

  .drop-zone input[type=file] {
    position: absolute; inset: 0;
    opacity: 0; cursor: pointer;
    width: 100%; height: 100%;
  }

  .drop-icon {
    color: var(--muted);
    margin-bottom: 4px;
    transition: color 0.3s, filter 0.3s;
  }
  .drop-zone:hover .drop-icon,
  .drop-zone.dragover .drop-icon {
    color: var(--cyan);
    filter: drop-shadow(0 0 10px var(--cyan));
  }

  .drop-title {
    font-family: 'Syne', sans-serif;
    font-size: 0.95rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .drop-sub {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.05em;
  }

  .file-selected {
    display: none;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
    padding: 12px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 2px solid var(--cyan);
  }
  .file-selected.visible { display: flex; }
  .file-info { flex: 1; overflow: hidden; }

  .file-name {
    font-family: 'Space Mono', monospace;
    font-size: 0.75rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--text);
  }
  .file-size {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    margin-top: 3px;
  }

  .btn-remove {
    background: none; border: none;
    color: var(--muted); cursor: pointer;
    padding: 4px; transition: color 0.15s, filter 0.15s; flex-shrink: 0;
  }
  .btn-remove:hover { color: #ff5566; filter: drop-shadow(0 0 4px rgba(255,85,102,0.4)); }

  .error-msg {
    display: none;
    margin-top: 10px;
    padding: 11px 14px;
    background: rgba(255, 50, 80, 0.05);
    border: 1px solid rgba(255, 50, 80, 0.2);
    border-left: 2px solid #ff5566;
    color: #ff7788;
    font-family: 'Space Mono', monospace;
    font-size: 0.72rem;
    line-height: 1.6;
    text-shadow: 0 0 6px rgba(255, 85, 102, 0.2);
  }
  .error-msg.visible { display: block; }

  .btn-analyze {
    display: none;
    width: 100%;
    margin-top: 12px;
    padding: 16px;
    background: var(--accent);
    color: #030308;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    font-weight: 800;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    position: relative;
    overflow: hidden;
  }
  .btn-analyze::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
    transform: translateX(-100%);
    transition: transform 0.4s;
  }
  .btn-analyze:hover::after { transform: translateX(100%); }
  .btn-analyze.visible  { display: block; }
  .btn-analyze:hover    { background: #f5ff70; box-shadow: 0 0 40px rgba(232,255,71,0.5); }
  .btn-analyze:active   { transform: scale(0.99); }
  .btn-analyze:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; box-shadow: none; }

  /* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
  #progress-section { display: none; text-align: center; }
  #progress-section.visible { display: block; }

  .progress-label {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--cyan);
    margin-bottom: 32px;
    opacity: 0.7;
  }

  /* ‚îÄ‚îÄ Warmup display (queued / loading_model) ‚îÄ‚îÄ */
  .warmup-display {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 18px;
    margin-bottom: 28px;
  }
  .warmup-display.visible { display: flex; }

  .warmup-icon svg {
    width: 64px; height: 64px;
    color: var(--cyan);
    filter: drop-shadow(0 0 18px rgba(0,245,255,0.6));
    animation: warmup-bob 1.9s ease-in-out infinite;
  }
  @keyframes warmup-bob {
    0%, 100% { transform: translateY(0)   scale(0.96); filter: drop-shadow(0 0 10px rgba(0,245,255,0.3)); }
    50%       { transform: translateY(-6px) scale(1.04); filter: drop-shadow(0 0 28px rgba(0,245,255,0.9)); }
  }

  .warmup-word {
    font-family: 'Syne', sans-serif;
    font-size: 1.55rem;
    font-weight: 800;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    background: linear-gradient(90deg, var(--cyan) 0%, var(--accent) 50%, var(--cyan) 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradient-slide 2.6s linear infinite;
    filter: drop-shadow(0 0 12px rgba(0,245,255,0.3));
  }
  @keyframes gradient-slide {
    from { background-position: 0%   center; }
    to   { background-position: 200% center; }
  }

  .warmup-sub {
    font-family: 'Space Mono', monospace;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.12em;
    line-height: 1.8;
  }
  .warmup-sub .dots { display: inline-block; min-width: 1.5em; text-align: left; }

  /* ‚îÄ‚îÄ Processing display (active %) ‚îÄ‚îÄ */
  .progress-pct {
    display: none;
    font-family: 'Space Mono', monospace;
    font-size: 5rem;
    font-weight: 400;
    letter-spacing: -0.04em;
    line-height: 1;
    margin-bottom: 28px;
    color: var(--text);
    text-shadow: 0 0 30px rgba(232, 255, 71, 0.15);
  }
  .progress-pct.visible { display: block; }
  .progress-pct span { font-size: 2rem; color: var(--muted); }

  /* ‚îÄ‚îÄ Bar ‚îÄ‚îÄ */
  .progress-bar-track {
    height: 2px;
    background: var(--border);
    position: relative;
    overflow: hidden;
    margin-bottom: 18px;
  }

  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--cyan), var(--accent));
    transition: width 0.6s ease;
    width: 0%;
    position: relative;
    box-shadow: 0 0 8px rgba(232,255,71,0.4);
  }

  /* Indeterminate scan when warming up */
  .progress-bar-fill.indeterminate {
    background: linear-gradient(90deg, var(--purple), var(--cyan));
    transition: none;
    animation: bar-scan 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    box-shadow: 0 0 12px rgba(0,245,255,0.5);
  }
  @keyframes bar-scan {
    0%   { width: 28%; margin-left: 0%; }
    50%  { width: 36%; margin-left: 55%; }
    100% { width: 28%; margin-left: 0%; }
  }

  .progress-bar-fill::after {
    content: '';
    position: absolute; top: 0; right: 0;
    width: 80px; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
    animation: shimmer 1.4s infinite;
  }
  @keyframes shimmer {
    from { transform: translateX(-80px); }
    to   { transform: translateX(80px); }
  }

  .progress-sub {
    font-family: 'Space Mono', monospace;
    font-size: 0.68rem;
    color: var(--muted);
    letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ Result ‚îÄ‚îÄ */
  #result-section { display: none; }
  #result-section.visible { display: block; }

  .result-player {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow: hidden;
    position: relative;
  }

  /* HUD corners on result player */
  .result-player::before, .result-player::after {
    content: '';
    position: absolute;
    width: 16px; height: 16px;
    border-color: var(--cyan);
    border-style: solid;
    opacity: 0.5;
    z-index: 2;
    pointer-events: none;
  }
  .result-player::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
  .result-player::after  { top: -1px; right: -1px; border-width: 2px 2px 0 0; }

  .result-player video { width: 100%; display: block; }

  .result-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    padding: 12px;
    border-top: 1px solid var(--border);
  }

  .btn-download {
    flex: 1;
    padding: 12px;
    background: var(--accent);
    color: #030308;
    border: none;
    font-family: 'Syne', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: background 0.15s, box-shadow 0.15s;
  }
  .btn-download:hover { background: #f5ff70; box-shadow: 0 0 20px rgba(232,255,71,0.4); }

  .btn-analysis {
    flex: 1;
    padding: 12px;
    background: none;
    color: var(--cyan);
    border: 1px solid rgba(0, 245, 255, 0.35);
    font-family: 'Syne', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  }
  .btn-analysis:hover {
    background: rgba(0, 245, 255, 0.08);
    border-color: var(--cyan);
    box-shadow: 0 0 20px rgba(0, 245, 255, 0.15);
  }

  .btn-agent {
    flex: 1;
    padding: 12px;
    background: none;
    color: var(--purple);
    border: 1px solid rgba(99, 102, 241, 0.35);
    font-family: 'Syne', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
  }
  .btn-agent:hover {
    background: rgba(99, 102, 241, 0.08);
    border-color: var(--purple);
    box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
  }

  .btn-another {
    padding: 12px;
    background: none;
    color: var(--muted);
    border: 1px solid var(--border);
    font-family: 'Syne', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: border-color 0.2s, color 0.2s, text-shadow 0.2s;
    white-space: nowrap;
  }
  .btn-another:hover { border-color: var(--text); color: var(--text); text-shadow: 0 0 6px rgba(255,255,255,0.15); }

  @media (max-width: 480px) {
    body { justify-content: flex-start; padding-top: 60px; }
    .logo { margin-bottom: 40px; }
  }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="aurora"></div>

<div class="logo">Stridelab</div>

<div class="card">

  <!-- Upload -->
  <section id="upload-section">
    <h1>Analyze your sprint</h1>
    <p>Upload side-view video ‚Üí get pose-annotated output with joint angles</p>

    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept="video/mp4,video/quicktime,video/x-msvideo,video/x-matroska,.mp4,.mov,.avi,.mkv"/>
      <div class="drop-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="drop-title">Drop video or browse</div>
      <div class="drop-sub">MP4 ¬∑ MOV ¬∑ AVI ¬∑ MKV &nbsp;¬∑&nbsp; max_size=500mb</div>
    </div>

    <div class="file-selected" id="file-selected">
      <div class="file-info">
        <div class="file-name" id="file-name"></div>
        <div class="file-size" id="file-size"></div>
      </div>
      <button class="btn-remove" id="btn-remove" title="Remove">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <div class="error-msg" id="error-msg"></div>
    <button class="btn-analyze" id="btn-analyze">Analyze</button>
  </section>

  <!-- Progress -->
  <section id="progress-section">
    <div class="progress-label" id="progress-stage">Processing</div>

    <!-- Warmup state: shown during queued / loading_model -->
    <div class="warmup-display" id="warmup-display">
      <div class="warmup-icon">
        <!-- Running figure SVG -->
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="13" cy="3.5" r="1.5"/>
          <path d="M10 8.5l-3 8"/>
          <path d="M10 8.5c1.5 1 3.5 1.5 5 1l-1.5 4"/>
          <path d="M7 16.5l2-1.5 2 3"/>
          <path d="M13.5 13.5l2 3.5"/>
        </svg>
      </div>
      <div class="warmup-word" id="warmup-word">Warming Up</div>
      <div class="warmup-sub" id="warmup-sub">
        Getting things ready<span class="dots" id="warmup-dots"></span>
      </div>
    </div>

    <!-- Processing state: shown when % > 0 -->
    <div class="progress-pct" id="progress-pct">
      <span id="progress-num">0</span><span>%</span>
    </div>

    <div class="progress-bar-track">
      <div class="progress-bar-fill indeterminate" id="progress-bar"></div>
    </div>
    <div class="progress-sub" id="progress-sub">Starting‚Ä¶</div>
  </section>

  <!-- Result -->
  <section id="result-section">
    <div class="result-player">
      <video id="result-video" controls playsinline></video>
      <div class="result-actions">
        <a class="btn-download" id="btn-download" href="#" download>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </a>
        <button class="btn-another" id="btn-another">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14m-7-7h14"/>
          </svg>
          New Upload
        </button>
        <a class="btn-analysis" id="btn-analysis" href="#">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
          </svg>
          View Analysis
        </a>
        <a class="btn-agent" id="btn-agent" href="#">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v2m0 18v2m-9-11h2m18 0h2m-3.3-6.7-1.4 1.4M5.7 18.3l-1.4 1.4m0-13.4 1.4 1.4m12.6 12.6 1.4 1.4"/>
          </svg>
          Agent Analysis
        </a>
      </div>
    </div>
  </section>

</div>

<script>
  let selectedFile = null;
  let jobId        = null;
  let pollTimer    = null;
  let dotsTimer    = null;

  const dropZone        = document.getElementById("drop-zone");
  const fileInput       = document.getElementById("file-input");
  const fileSelected    = document.getElementById("file-selected");
  const fileNameEl      = document.getElementById("file-name");
  const fileSizeEl      = document.getElementById("file-size");
  const btnRemove       = document.getElementById("btn-remove");
  const btnAnalyze      = document.getElementById("btn-analyze");
  const errorMsg        = document.getElementById("error-msg");
  const uploadSection   = document.getElementById("upload-section");
  const progressSection = document.getElementById("progress-section");
  const resultSection   = document.getElementById("result-section");
  const progressStage   = document.getElementById("progress-stage");
  const progressPct     = document.getElementById("progress-pct");
  const progressNum     = document.getElementById("progress-num");
  const progressBar     = document.getElementById("progress-bar");
  const progressSub     = document.getElementById("progress-sub");
  const warmupDisplay   = document.getElementById("warmup-display");
  const warmupWord      = document.getElementById("warmup-word");
  const warmupSub       = document.getElementById("warmup-sub");
  const warmupDots      = document.getElementById("warmup-dots");
  const resultVideo     = document.getElementById("result-video");
  const btnDownload     = document.getElementById("btn-download");
  const btnAnalysis     = document.getElementById("btn-analysis");
  const btnAgent        = document.getElementById("btn-agent");
  const btnAnother      = document.getElementById("btn-another");

  // Cycling warmup messages
  const WARMUP_MESSAGES = [
    { word: "Warming Up",   sub: "Getting things ready" },
    { word: "Getting Set",  sub: "Lacing up" },
    { word: "Almost Ready", sub: "On your marks" },
    { word: "Hold Tight",   sub: "Good things take a moment" },
  ];
  let warmupIdx = 0;
  let warmupCycleTimer = null;

  function startWarmupAnimation() {
    // Animated dots: . .. ...
    let dotCount = 0;
    dotsTimer = setInterval(() => {
      dotCount = (dotCount + 1) % 4;
      warmupDots.textContent = ".".repeat(dotCount);
    }, 500);

    // Cycle through warmup phrases every ~3.5 s
    warmupIdx = 0;
    warmupCycleTimer = setInterval(() => {
      warmupIdx = (warmupIdx + 1) % WARMUP_MESSAGES.length;
      const { word, sub } = WARMUP_MESSAGES[warmupIdx];
      // Fade via opacity trick
      warmupWord.style.opacity = "0";
      warmupSub.style.opacity  = "0";
      setTimeout(() => {
        warmupWord.textContent = word;
        // Reconstruct sub with dots span
        warmupSub.innerHTML = sub + '<span class="dots" id="warmup-dots"></span>';
        // Re-grab dots reference after innerHTML rebuild
        const newDots = warmupSub.querySelector(".dots");
        warmupWord.style.opacity = "1";
        warmupSub.style.opacity  = "1";
      }, 300);
    }, 3500);

    // Smooth opacity transition
    warmupWord.style.transition = "opacity 0.3s ease";
    warmupSub.style.transition  = "opacity 0.3s ease";
  }

  function stopWarmupAnimation() {
    clearInterval(dotsTimer);
    clearInterval(warmupCycleTimer);
  }

  function enterProcessingMode() {
    warmupDisplay.classList.remove("visible");
    progressBar.classList.remove("indeterminate");
    progressPct.classList.add("visible");
    stopWarmupAnimation();
  }

  function formatBytes(b) {
    return b < 1024 * 1024
      ? (b / 1024).toFixed(1) + " KB"
      : (b / (1024 * 1024)).toFixed(1) + " MB";
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add("visible");
  }

  function clearError() {
    errorMsg.classList.remove("visible");
  }

  function setFile(file) {
    selectedFile = file;
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = formatBytes(file.size);
    fileSelected.classList.add("visible");
    btnAnalyze.classList.add("visible");
    clearError();
  }

  function clearFile() {
    selectedFile = null;
    fileInput.value = "";
    fileSelected.classList.remove("visible");
    btnAnalyze.classList.remove("visible");
    clearError();
  }

  dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith("video/")) setFile(file);
  });
  fileInput.addEventListener("change", () => { if (fileInput.files[0]) setFile(fileInput.files[0]); });
  btnRemove.addEventListener("click", clearFile);

  btnAnalyze.addEventListener("click", async () => {
    if (!selectedFile) return;
    btnAnalyze.disabled    = true;
    btnAnalyze.textContent = "Uploading‚Ä¶";
    clearError();

    const formData = new FormData();
    formData.append("file", selectedFile);

    try {
      const tokenRes = await fetch("/upload-token");
      if (!tokenRes.ok) throw new Error("Could not obtain upload token.");
      const { upload_url, token } = await tokenRes.json();

      const res  = await fetch(upload_url, {
        method:  "POST",
        headers: { "X-Upload-Token": token },
        body:    formData,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Upload failed.");

      jobId = data.job_id;
      uploadSection.style.display = "none";

      // Start in warmup mode
      progressStage.textContent = "Preparing";
      warmupDisplay.classList.add("visible");
      progressBar.classList.add("indeterminate");
      progressPct.classList.remove("visible");
      progressSection.classList.add("visible");
      startWarmupAnimation();
      startPolling();

    } catch (err) {
      showError(err.message);
      btnAnalyze.disabled    = false;
      btnAnalyze.textContent = "Analyze";
    }
  });

  function startPolling() {
    pollTimer = setInterval(pollStatus, 2500);
  }

  let wasWarmingUp = true;

  async function pollStatus() {
    try {
      const res  = await fetch(`/status/${jobId}`);
      const data = await res.json();
      const pct  = data.progress || 0;

      const stages = {
        queued:        "Preparing",
        loading_model: "Preparing",
        processing:    "Analyzing",
        done:          "Done",
      };

      progressStage.textContent = stages[data.status] || data.status;

      if (data.status === "processing" || data.status === "done") {
        // Switch from warmup to progress % diplay
        if (wasWarmingUp) {
          wasWarmingUp = false;
          enterProcessingMode();
        }
        progressBar.style.width = `${pct}%`;
        progressNum.textContent  = pct.toFixed(0);
        progressSub.textContent  = data.status === "processing"
          ? `${pct.toFixed(1)}% complete`
          : "";
      } else {
        // Still warming up ‚Äî bar stays indeterminate, no % shown
        progressSub.textContent = "";
      }

      if (data.status === "done") {
        clearInterval(pollTimer);
        stopWarmupAnimation();
        showResult();
      }
    } catch (_) { /* retry on network blip */ }
  }

  function showResult() {
    const url = `/download/${jobId}`;
    resultVideo.src  = url;
    btnDownload.href = url;
    btnDownload.setAttribute("download", `sprint_${jobId.slice(0, 8)}.mp4`);
    btnAnalysis.href = `/analysis.html?job=${jobId}`;
    btnAgent.href    = `/agent.html?job=${jobId}`;
    progressSection.classList.remove("visible");
    resultSection.classList.add("visible");
  }

  btnAnother.addEventListener("click", () => {
    jobId        = null;
    wasWarmingUp = true;
    clearFile();
    stopWarmupAnimation();
    resultVideo.src = "";
    resultSection.classList.remove("visible");
    progressSection.classList.remove("visible");
    uploadSection.style.display = "";
    progressBar.classList.add("indeterminate");
    progressBar.style.width = "0%";
    progressNum.textContent = "0";
    progressPct.classList.remove("visible");
    warmupDisplay.classList.remove("visible");
    btnAnalyze.disabled     = false;
    btnAnalyze.textContent  = "Analyze";
  });
</script>

<!-- Animated particle background -->
<script>
(function() {
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  let w, h, particles, gridPhase = 0;

  function resize() {
    w = canvas.width = window.innerWidth;
    h = canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // Particles
  const PARTICLE_COUNT = 60;
  particles = [];
  for (let i = 0; i < PARTICLE_COUNT; i++) {
    particles.push({
      x: Math.random() * w,
      y: Math.random() * h,
      vx: (Math.random() - 0.5) * 0.3,
      vy: (Math.random() - 0.5) * 0.3,
      r: Math.random() * 1.5 + 0.5,
      alpha: Math.random() * 0.4 + 0.1,
      color: Math.random() > 0.5 ? '0,245,255' : '99,102,241',
      pulse: Math.random() * Math.PI * 2,
      pulseSpeed: Math.random() * 0.02 + 0.005,
    });
  }

  function draw() {
    ctx.clearRect(0, 0, w, h);
    gridPhase += 0.003;

    // Animated grid
    const gridSize = 40;
    const gridAlphaBase = 0.025;
    ctx.lineWidth = 0.5;
    for (let x = 0; x < w; x += gridSize) {
      const wave = Math.sin(x * 0.005 + gridPhase) * 0.015 + gridAlphaBase;
      ctx.strokeStyle = `rgba(0, 245, 255, ${wave})`;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, h);
      ctx.stroke();
    }
    for (let y = 0; y < h; y += gridSize) {
      const wave = Math.sin(y * 0.005 + gridPhase * 1.3) * 0.015 + gridAlphaBase;
      ctx.strokeStyle = `rgba(0, 245, 255, ${wave})`;
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(w, y);
      ctx.stroke();
    }

    // Draw particles
    for (const p of particles) {
      p.x += p.vx;
      p.y += p.vy;
      p.pulse += p.pulseSpeed;

      // Wrap around
      if (p.x < -10) p.x = w + 10;
      if (p.x > w + 10) p.x = -10;
      if (p.y < -10) p.y = h + 10;
      if (p.y > h + 10) p.y = -10;

      const pulseAlpha = p.alpha * (0.6 + 0.4 * Math.sin(p.pulse));

      // Glow
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r * 4, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${p.color}, ${pulseAlpha * 0.15})`;
      ctx.fill();

      // Core
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${p.color}, ${pulseAlpha})`;
      ctx.fill();
    }

    // Draw connections between nearby particles
    ctx.lineWidth = 0.5;
    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 120) {
          const alpha = (1 - dist / 120) * 0.08;
          ctx.strokeStyle = `rgba(0, 245, 255, ${alpha})`;
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.stroke();
        }
      }
    }

    requestAnimationFrame(draw);
  }

  draw();
})();
</script>
</body>
</html>