<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stridelab</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg:      #0a0a0a;
    --surface: #111;
    --border:  #222;
    --text:    #e0e0e0;
    --muted:   #555;
    --accent:  #e8ff47;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-weight: 300;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 24px;
  }

  .logo {
    font-size: 0.8rem;
    font-weight: 500;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 64px;
  }

  .card {
    width: 100%;
    max-width: 480px;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ── Upload ── */
  #upload-section h1 {
    font-size: 1.6rem;
    font-weight: 300;
    letter-spacing: -0.02em;
    margin-bottom: 8px;
  }

  #upload-section p {
    font-size: 0.85rem;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 36px;
  }

  .drop-zone {
    border: 1px dashed var(--border);
    padding: 48px 24px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    position: relative;
    transition: border-color 0.2s, background 0.2s;
    text-align: center;
  }

  .drop-zone:hover,
  .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(232, 255, 71, 0.02);
  }

  .drop-zone input[type=file] {
    position: absolute; inset: 0;
    opacity: 0; cursor: pointer;
    width: 100%; height: 100%;
  }

  .drop-icon { color: var(--muted); margin-bottom: 4px; transition: color 0.2s; }
  .drop-zone:hover .drop-icon,
  .drop-zone.dragover .drop-icon { color: var(--accent); }

  .drop-title { font-size: 0.9rem; font-weight: 400; }
  .drop-sub   { font-size: 0.75rem; color: var(--muted); }

  .file-selected {
    display: none;
    align-items: center;
    gap: 12px;
    margin-top: 10px;
    padding: 12px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
  }

  .file-selected.visible { display: flex; }
  .file-info { flex: 1; overflow: hidden; }

  .file-name {
    font-size: 0.82rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .file-size { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }

  .btn-remove {
    background: none; border: none;
    color: var(--muted); cursor: pointer;
    padding: 4px; transition: color 0.15s; flex-shrink: 0;
  }
  .btn-remove:hover { color: #ff6b6b; }

  .error-msg {
    display: none;
    margin-top: 12px;
    padding: 11px 14px;
    background: rgba(255, 80, 80, 0.07);
    border: 1px solid rgba(255, 80, 80, 0.18);
    color: #ff8080;
    font-size: 0.8rem;
    line-height: 1.5;
  }
  .error-msg.visible { display: block; }

  .btn-analyze {
    display: none;
    width: 100%;
    margin-top: 14px;
    padding: 15px;
    background: var(--accent);
    color: #0a0a0a;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.82rem;
    font-weight: 500;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    transition: background 0.15s;
  }
  .btn-analyze.visible  { display: block; }
  .btn-analyze:hover    { background: #d4eb3a; }
  .btn-analyze:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; }

  /* ── Progress ── */
  #progress-section { display: none; text-align: center; }
  #progress-section.visible { display: block; }

  .progress-label {
    font-size: 0.75rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 32px;
  }

  .progress-pct {
    font-size: 5rem;
    font-weight: 300;
    letter-spacing: -0.04em;
    line-height: 1;
    margin-bottom: 28px;
  }
  .progress-pct span { font-size: 2rem; color: var(--muted); }

  .progress-bar-track {
    height: 1px;
    background: var(--border);
    position: relative;
    overflow: hidden;
    margin-bottom: 18px;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.6s ease;
    width: 0%;
  }

  .progress-bar-fill::after {
    content: '';
    position: absolute; top: 0; right: 0;
    width: 80px; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
    animation: shimmer 1.4s infinite;
  }

  @keyframes shimmer {
    from { transform: translateX(-80px); }
    to   { transform: translateX(80px); }
  }

  .progress-sub { font-size: 0.78rem; color: var(--muted); }

  /* ── Result ── */
  #result-section { display: none; }
  #result-section.visible { display: block; }

  .result-player {
    background: var(--surface);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .result-player video { width: 100%; display: block; }

  .result-actions {
    display: flex;
    gap: 10px;
    padding: 12px;
    border-top: 1px solid var(--border);
  }

  .btn-download {
    flex: 1;
    padding: 12px;
    background: var(--accent);
    color: #0a0a0a;
    border: none;
    font-family: 'Inter', sans-serif;
    font-size: 0.78rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 7px;
    transition: background 0.15s;
  }
  .btn-download:hover { background: #d4eb3a; }

  .btn-another {
    padding: 12px 20px;
    background: none;
    color: var(--muted);
    border: 1px solid var(--border);
    font-family: 'Inter', sans-serif;
    font-size: 0.78rem;
    cursor: pointer;
    transition: border-color 0.15s, color 0.15s;
    white-space: nowrap;
  }
  .btn-another:hover { border-color: var(--text); color: var(--text); }

  @media (max-width: 480px) {
    body { justify-content: flex-start; padding-top: 60px; }
    .logo { margin-bottom: 40px; }
  }
</style>
</head>
<body>

<div class="logo">Stridelab</div>

<div class="card">

  <!-- Upload -->
  <section id="upload-section">
    <h1>Analyze your sprint</h1>
    <p>Upload a side-view running video and get a pose-annotated output with joint angles overlaid.</p>

    <div class="drop-zone" id="drop-zone">
      <input type="file" id="file-input" accept="video/mp4,video/quicktime,video/x-msvideo,video/x-matroska,.mp4,.mov,.avi,.mkv"/>
      <div class="drop-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
          <polyline points="17 8 12 3 7 8"/>
          <line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
      </div>
      <div class="drop-title">Drop video or click to browse</div>
      <div class="drop-sub">MP4 · MOV · AVI · MKV &nbsp;·&nbsp; Max 500 MB</div>
    </div>

    <div class="file-selected" id="file-selected">
      <div class="file-info">
        <div class="file-name" id="file-name"></div>
        <div class="file-size" id="file-size"></div>
      </div>
      <button class="btn-remove" id="btn-remove" title="Remove">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <div class="error-msg" id="error-msg"></div>
    <button class="btn-analyze" id="btn-analyze">Analyze</button>
  </section>

  <!-- Progress -->
  <section id="progress-section">
    <div class="progress-label" id="progress-stage">Processing</div>
    <div class="progress-pct"><span id="progress-num">0</span><span>%</span></div>
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progress-bar"></div>
    </div>
    <div class="progress-sub" id="progress-sub">Starting…</div>
  </section>

  <!-- Result -->
  <section id="result-section">
    <div class="result-player">
      <video id="result-video" controls playsinline></video>
      <div class="result-actions">
        <a class="btn-download" id="btn-download" href="#" download>
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Download
        </a>
        <button class="btn-another" id="btn-another">Analyze another</button>
      </div>
    </div>
  </section>

</div>

<script>
  let selectedFile = null;
  let jobId        = null;
  let pollTimer    = null;

  const dropZone        = document.getElementById("drop-zone");
  const fileInput       = document.getElementById("file-input");
  const fileSelected    = document.getElementById("file-selected");
  const fileNameEl      = document.getElementById("file-name");
  const fileSizeEl      = document.getElementById("file-size");
  const btnRemove       = document.getElementById("btn-remove");
  const btnAnalyze      = document.getElementById("btn-analyze");
  const errorMsg        = document.getElementById("error-msg");
  const uploadSection   = document.getElementById("upload-section");
  const progressSection = document.getElementById("progress-section");
  const resultSection   = document.getElementById("result-section");
  const progressStage   = document.getElementById("progress-stage");
  const progressNum     = document.getElementById("progress-num");
  const progressBar     = document.getElementById("progress-bar");
  const progressSub     = document.getElementById("progress-sub");
  const resultVideo     = document.getElementById("result-video");
  const btnDownload     = document.getElementById("btn-download");
  const btnAnother      = document.getElementById("btn-another");

  function formatBytes(b) {
    return b < 1024 * 1024
      ? (b / 1024).toFixed(1) + " KB"
      : (b / (1024 * 1024)).toFixed(1) + " MB";
  }

  function showError(msg) {
    errorMsg.textContent = msg;
    errorMsg.classList.add("visible");
  }

  function clearError() {
    errorMsg.classList.remove("visible");
  }

  function setFile(file) {
    selectedFile = file;
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = formatBytes(file.size);
    fileSelected.classList.add("visible");
    btnAnalyze.classList.add("visible");
    clearError();
  }

  function clearFile() {
    selectedFile = null;
    fileInput.value = "";
    fileSelected.classList.remove("visible");
    btnAnalyze.classList.remove("visible");
    clearError();
  }

  dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("dragover"); });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", e => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith("video/")) setFile(file);
    else if (file) showError("Please upload a video file (MP4, MOV, AVI, or MKV).");
  });
  fileInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) setFile(file);
  });
  // Ensure clicking anywhere on the drop zone opens the file picker
  dropZone.addEventListener("click", e => {
    if (e.target !== fileInput) fileInput.click();
  });
  btnRemove.addEventListener("click", e => { e.stopPropagation(); clearFile(); });

  btnAnalyze.addEventListener("click", async () => {
    if (!selectedFile) return;
    btnAnalyze.disabled    = true;
    btnAnalyze.textContent = "Uploading…";
    clearError();

    const formData = new FormData();
    formData.append("file", selectedFile);

    try {
      // Step 1: get a short-lived upload token (API_SECRET never leaves the server)
      const tokenRes = await fetch("/upload-token");
      if (!tokenRes.ok) throw new Error("Could not obtain upload token.");
      const { upload_url, token } = await tokenRes.json();

      // Step 2: upload directly to Modal — bypasses Vercel's 4.5 MB limit
      const res  = await fetch(upload_url, {
        method:  "POST",
        headers: { "X-Upload-Token": token },
        body:    formData,
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.detail || "Upload failed.");

      jobId = data.job_id;
      uploadSection.style.display = "none";
      progressSection.classList.add("visible");
      startPolling();

    } catch (err) {
      showError(err.message);
      btnAnalyze.disabled    = false;
      btnAnalyze.textContent = "Analyze";
    }
  });

  function startPolling() {
    pollTimer = setInterval(pollStatus, 2500);
  }

  async function pollStatus() {
    try {
      const res  = await fetch(`/status/${jobId}`);
      const data = await res.json();
      const pct  = data.progress || 0;

      progressBar.style.width = `${pct}%`;
      progressNum.textContent  = pct.toFixed(0);

      const stages = {
        queued:        "Starting…",
        loading_model: "Loading model…",
        processing:    "Analyzing…",
        done:          "Done",
      };

      progressStage.textContent = stages[data.status] || data.status;
      progressSub.textContent   = data.status === "processing"
        ? `${pct.toFixed(1)}% complete`
        : "";

      if (data.status === "done") {
        clearInterval(pollTimer);
        showResult();
      }
    } catch (_) { /* retry on network blip */ }
  }

  function showResult() {
    const url = `/download/${jobId}`;
    resultVideo.src  = url;
    btnDownload.href = url;
    btnDownload.setAttribute("download", `sprint_${jobId.slice(0, 8)}.mp4`);
    progressSection.classList.remove("visible");
    resultSection.classList.add("visible");
  }

  btnAnother.addEventListener("click", () => {
    jobId = null;
    clearFile();
    resultVideo.src = "";
    resultSection.classList.remove("visible");
    progressSection.classList.remove("visible");
    uploadSection.style.display = "";
    progressBar.style.width = "0%";
    progressNum.textContent = "0";
    btnAnalyze.disabled     = false;
    btnAnalyze.textContent  = "Analyze";
    btnAnalyze.classList.remove("visible"); // ensure clean state after reset
  });
</script>
</body>
</html>